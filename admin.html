<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞–º–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .init-btn {
            background: #ffc107;
            color: #000;
        }
        .init-btn:hover {
            background: #e0a800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        .step-column {
            min-width: 200px;
            max-width: 300px;
        }
        .domain-item {
            background: #f8f9fa;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        .domain-item.inactive {
            border-left-color: #dc3545;
            opacity: 0.6;
        }
        .domain-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .domain-item-url {
            font-weight: 500;
            color: #333;
            word-break: break-all;
        }
        .domain-item-actions {
            display: flex;
            gap: 5px;
        }
        .domain-item-actions button {
            padding: 4px 8px;
            font-size: 11px;
            margin: 0;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞–º–∏</h1>
        
        <div id="message" class="message"></div>

        <div class="form-section">
            <h2>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="margin-bottom: 15px; color: #666;">–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑)</p>
            <button class="init-btn" onclick="initDatabase()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î</button>
        </div>

        <div class="form-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">–î–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω –¥–æ–º–µ–Ω</button>
                <button class="tab" onclick="switchTab('bulk')">–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</button>
            </div>

            <div id="singleTab" class="tab-content active">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω</h2>
                <form id="addForm" onsubmit="addDomain(event)">
                    <div class="form-group">
                        <label for="step">–®–∞–≥ –æ–ø—Ä–æ—Å–∞:</label>
                        <select id="step" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–≥</option>
                            <option value="1">–®–∞–≥ 1</option>
                            <option value="2">–®–∞–≥ 2</option>
                            <option value="3">–®–∞–≥ 3</option>
                            <option value="4">–®–∞–≥ 4</option>
                            <option value="5">–®–∞–≥ 5</option>
                            <option value="6">–®–∞–≥ 6</option>
                            <option value="7">–®–∞–≥ 7</option>
                            <option value="8">–®–∞–≥ 8</option>
                            <option value="9">–®–∞–≥ 9</option>
                            <option value="10">–®–∞–≥ 10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="domain">–î–æ–º–µ–Ω:</label>
                        <input type="text" id="domain" placeholder="example.com –∏–ª–∏ https://example.com" required>
                        <div class="help-text">https:// –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω</div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="active" checked> –ê–∫—Ç–∏–≤–µ–Ω
                        </label>
                    </div>
                    <button type="submit" class="success">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω</button>
                </form>
            </div>

            <div id="bulkTab" class="tab-content">
                <h2>–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–µ–Ω–æ–≤</h2>
                <form id="bulkForm" onsubmit="addBulkDomains(event)">
                    <div class="form-group">
                        <label for="bulkStep">–®–∞–≥ –æ–ø—Ä–æ—Å–∞:</label>
                        <select id="bulkStep" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–≥</option>
                            <option value="1">–®–∞–≥ 1</option>
                            <option value="2">–®–∞–≥ 2</option>
                            <option value="3">–®–∞–≥ 3</option>
                            <option value="4">–®–∞–≥ 4</option>
                            <option value="5">–®–∞–≥ 5</option>
                            <option value="6">–®–∞–≥ 6</option>
                            <option value="7">–®–∞–≥ 7</option>
                            <option value="8">–®–∞–≥ 8</option>
                            <option value="9">–®–∞–≥ 9</option>
                            <option value="10">–®–∞–≥ 10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkDomains">–î–æ–º–µ–Ω—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
                        <textarea id="bulkDomains" placeholder="example1.com&#10;example2.com&#10;https://example3.com" required></textarea>
                        <div class="help-text">–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω—ã, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. https:// –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω.</div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="bulkActive" checked> –í—Å–µ –¥–æ–º–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã
                        </label>
                    </div>
                    <button type="submit" class="success">–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –¥–æ–º–µ–Ω—ã</button>
                </form>
            </div>
        </div>

        <div class="form-section">
            <h2>–°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –ø–æ —à–∞–≥–∞–º</h2>
            <button onclick="loadDomains()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="domainsTable">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function normalizeDomain(domain) {
            if (!domain) return domain;
            domain = domain.trim();
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª, –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
            if (domain.startsWith('http://') || domain.startsWith('https://')) {
                return domain;
            }
            // –î–æ–±–∞–≤–∏—Ç—å https://
            return 'https://' + domain;
        }

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'single') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('singleTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('bulkTab').classList.add('active');
            }
        }

        async function initDatabase() {
            try {
                const response = await fetch(`${API_BASE}/api/init-db`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
                } else {
                    showMessage(`–û—à–∏–±–∫–∞: ${data.error || data.details}`, 'error');
                }
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function addDomain(event) {
            event.preventDefault();
            const step = document.getElementById('step').value;
            let domain = document.getElementById('domain').value.trim();
            const active = document.getElementById('active').checked;

            // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–æ–º–µ–Ω (–¥–æ–±–∞–≤–∏—Ç—å https:// –µ—Å–ª–∏ –Ω–µ—Ç)
            domain = normalizeDomain(domain);

            try {
                const response = await fetch(`${API_BASE}/api/add-domain`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ step: Number(step), domain, active })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('–î–æ–º–µ–Ω —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    document.getElementById('addForm').reset();
                    loadDomains();
                } else {
                    showMessage(`–û—à–∏–±–∫–∞: ${data.error || data.details}`, 'error');
                }
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function addBulkDomains(event) {
            event.preventDefault();
            const step = document.getElementById('bulkStep').value;
            const domainsText = document.getElementById('bulkDomains').value;
            const active = document.getElementById('bulkActive').checked;

            if (!step || !domainsText.trim()) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            // –†–∞–∑–±–∏—Ç—å –Ω–∞ —Å—Ç—Ä–æ–∫–∏, –æ—á–∏—Å—Ç–∏—Ç—å –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å
            const domains = domainsText.split('\n')
                .map(d => normalizeDomain(d.trim()))
                .filter(d => d.length > 0);

            if (domains.length === 0) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–º–µ–Ω', 'error');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const domain of domains) {
                try {
                    const response = await fetch(`${API_BASE}/api/add-domain`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ step: Number(step), domain, active })
                    });
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            if (errorCount === 0) {
                showMessage(`–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${successCount} –¥–æ–º–µ–Ω–æ–≤!`, 'success');
                document.getElementById('bulkForm').reset();
                loadDomains();
            } else {
                showMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${successCount} –¥–æ–º–µ–Ω–æ–≤, –æ—à–∏–±–æ–∫: ${errorCount}`, 'error');
                loadDomains();
            }
        }

        async function loadDomains() {
            const tableDiv = document.getElementById('domainsTable');
            tableDiv.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/domains`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                if (data.domains.length === 0) {
                    tableDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">–î–æ–º–µ–Ω—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º–µ–Ω—ã –ø–æ —à–∞–≥–∞–º
                const domainsByStep = {};
                let maxStep = 0;
                data.domains.forEach(domain => {
                    if (!domainsByStep[domain.step]) {
                        domainsByStep[domain.step] = [];
                    }
                    domainsByStep[domain.step].push(domain);
                    if (domain.step > maxStep) {
                        maxStep = domain.step;
                    }
                });

                // –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Å—Ç–æ–ª–±—Ü–∞–º–∏ –ø–æ —à–∞–≥–∞–º
                let html = '<div style="overflow-x: auto;"><table><thead><tr>';
                
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
                for (let step = 1; step <= maxStep; step++) {
                    const count = domainsByStep[step] ? domainsByStep[step].length : 0;
                    html += `<th class="step-column">–®–∞–≥ ${step} (${count})</th>`;
                }
                html += '</tr></thead><tbody>';

                // –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–º–µ–Ω–æ–≤ –≤ –æ–¥–Ω–æ–º —à–∞–≥–µ
                let maxDomains = 0;
                for (let step = 1; step <= maxStep; step++) {
                    const count = domainsByStep[step] ? domainsByStep[step].length : 0;
                    if (count > maxDomains) {
                        maxDomains = count;
                    }
                }

                // –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–æ–º–µ–Ω–æ–≤)
                for (let row = 0; row < maxDomains; row++) {
                    html += '<tr>';
                    
                    // –î–æ–º–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
                    for (let step = 1; step <= maxStep; step++) {
                        const stepDomains = domainsByStep[step] || [];
                        const domain = stepDomains[row];
                        
                        if (domain) {
                            const lastUsed = domain.last_used 
                                ? new Date(domain.last_used).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
                                : '–ù–∏–∫–æ–≥–¥–∞';
                            html += `
                                <td class="step-column">
                                    <div class="domain-item ${domain.active ? '' : 'inactive'}">
                                        <div class="domain-item-header">
                                            <span class="domain-item-url">${domain.domain}</span>
                                            <span class="status-badge ${domain.active ? 'status-active' : 'status-inactive'}">
                                                ${domain.active ? '‚úì' : '‚úó'}
                                            </span>
                                        </div>
                                        <div style="font-size: 10px; color: #666; margin-bottom: 5px;">
                                            ID: ${domain.id} | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: ${lastUsed}
                                        </div>
                                        <div class="domain-item-actions">
                                            <button onclick="toggleDomain(${domain.id}, ${!domain.active})" 
                                                    class="${domain.active ? 'danger' : 'success'}"
                                                    style="font-size: 10px; padding: 3px 6px;">
                                                ${domain.active ? '‚úó' : '‚úì'}
                                            </button>
                                            <button onclick="deleteDomain(${domain.id})" class="danger"
                                                    style="font-size: 10px; padding: 3px 6px;">üóë</button>
                                        </div>
                                    </div>
                                </td>
                            `;
                        } else {
                            html += '<td class="step-column"></td>';
                        }
                    }
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
                tableDiv.innerHTML = html;
            } catch (error) {
                tableDiv.innerHTML = `<p style="color: #dc3545;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        async function toggleDomain(id, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/api/domain/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ active: newStatus })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('–°—Ç–∞—Ç—É—Å –¥–æ–º–µ–Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
                    loadDomains();
                } else {
                    showMessage(`–û—à–∏–±–∫–∞: ${data.error || data.details}`, 'error');
                }
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function deleteDomain(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–º–µ–Ω?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/domain/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('–î–æ–º–µ–Ω —É–¥–∞–ª—ë–Ω!', 'success');
                    loadDomains();
                } else {
                    showMessage(`–û—à–∏–±–∫–∞: ${data.error || data.details}`, 'error');
                }
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–º–µ–Ω—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadDomains();
    </script>
</body>
</html>
